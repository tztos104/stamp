name: Deploy to Dev-Server (LXC 220)
on:
  push:
    branches: ["develop"]

jobs:
  deploy:
    # ğŸ·ï¸ 220ë²ˆ ì„œë²„(ê°œë°œ)ì—ì„œ ì‹¤í–‰
    runs-on: [self-hosted, dev-server]

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v4
      - name: Clean Previous Build Artifacts
        run: |
          rm -rf node_modules
          rm -rf build
          rm -rf .react-router
          rm -rf .cache
          pnpm store prune
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # ğŸ” 1. í‚¤ íŒŒì¼ ìƒì„±
      - name: Create Secure Key
        run: echo "${{ secrets.SECURE_KEY_CONTENT }}" > secure.key

      # ğŸ” 2. í™˜ê²½ë³€ìˆ˜ ë³µí˜¸í™”
      - name: Decrypt Env
        run: node scripts/crypt.mjs decrypt

      # ğŸ”„ 3. ê°œë°œìš© ì„¤ì • ì ìš©
      - name: Apply Dev Env
        run: mv .env.staging .env

      - name: Generate Prisma Client
        run: pnpm prisma generate

      # ğŸŒŸ 4. DB ë§ˆì´ê·¸ë ˆì´ì…˜
      - name: DB Migration
        run: pnpm prisma migrate deploy

      # ğŸŒ± 5. DB ì‹œë”© - â­ ì¶”ê°€ëœ ë¶€ë¶„!
      - name: DB Seed
        run: pnpm prisma db seed

      - name: Build
        run: pnpm build

      - name: PM2 Reload (Development)
        run: |
          pm2 restart

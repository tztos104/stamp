name: Deploy to Web-Prod (LXC 210)
on:
  push:
    branches: ["main"]

jobs:
  deploy:
    # ğŸ·ï¸ 210ë²ˆ ì„œë²„(ìš´ì˜)ì—ì„œ ì‹¤í–‰
    runs-on: [self-hosted, web-prod]

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      # ğŸ” 1. í‚¤ íŒŒì¼ ìƒì„±
      - name: Create Secure Key
        run: echo "${{ secrets.SECURE_KEY_CONTENT }}" > secure.key

      # ğŸ” 2. í™˜ê²½ë³€ìˆ˜ ë³µí˜¸í™”
      - name: Decrypt Env
        run: node scripts/crypt.mjs decrypt

      # 3. ìš´ì˜ í™˜ê²½ íŒŒì¼ í™•ì¸ (í•„ìš”ì‹œ ì´ë¦„ ë³€ê²½ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)

      - name: Generate Prisma Client
        run: pnpm prisma generate

      # ğŸŒŸ 4. DB ë§ˆì´ê·¸ë ˆì´ì…˜ (í…Œì´ë¸” ìƒì„±/ìˆ˜ì •)
      - name: DB Migration
        run: pnpm prisma migrate deploy

      # ğŸŒ± 5. DB ì‹œë”© (ì´ˆê¸° ë°ì´í„° ì£¼ì…) - â­ ì¶”ê°€ëœ ë¶€ë¶„!
      # package.jsonì— ì„¤ì •ëœ "prisma": {"seed": ...} ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: DB Seed
        run: pnpm prisma db seed

      - name: Build
        run: pnpm build

      - name: PM2 Reload (Production)
        run: |
          pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production
          pm2 save
